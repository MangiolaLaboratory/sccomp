---
title: "Overview of the sccomp package"
author: "Stefano Mangiola"
date: "`r Sys.Date()`"
package: sccomp
output:
  BiocStyle::html_document:
    toc_float: true
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{Overview of the sccomp package}
  %\usepackage[UTF-8]{inputenc}
---

<!-- badges: start -->
[![Lifecycle:maturing](https://img.shields.io/badge/lifecycle-maturing-blue.svg)](https://www.tidyverse.org/lifecycle/#maturing) [![R build status](https://github.com/stemangiola/tidyseurat/workflows/R-CMD-check/badge.svg)](https://github.com/stemangiola/tidyseurat/actions/)
<!-- badges: end -->

#  <img src="figures/logo-01.png" height="139px" width="120px" />

```{r echo=FALSE}
knitr::opts_chunk$set( fig.path = "figures/")
```


```{r message=FALSE, warning=FALSE}
library(dplyr)
library(sccomp)
library(ggplot2)
library(forcats)
library(tidyr)
library(tidyseurat)
library(tidySingleCellExperiment)

data("seurat_obj")
data("sce_obj")
data("counts_obj")
```

Single-cell transcriptomics allows the unbiased characterisation of the cellular composition of tissues. The cellular composition can be compared between biological or clinical conditions to identify potential cellular drivers. This strategy has been critical to unveil drivers of immune response in cancer and pathogen infection from single-cell data. Developing a robust statistical method for differential composition analyses from single-cell data is crucial for driving discoveries. The compositional data from single-cell experiments has four main properties. The data is in count form; counts underlie inversely correlated proportions that sum to one; larger cell groups are more variable across samples than small groups; real-world data is rich in outlier observation. A model that covers more than two of these properties is currently lacking. **Here, we present a robust and outlier-aware method for testing differential tissue composition from single-cell data. This model can also transfer knowledge from a large set of integrated datasets to increase accuracy further. We present how this model can be applied to identify novel compositional and heterogeneity changes in existing studies.**

# Installation 

**Bioconductor**

```{r eval=FALSE}
if (!requireNamespace("BiocManager")) {
   install.packages("BiocManager")
 }
 BiocManager::install("sccomp")
```

**Github**

```{r eval=FALSE}
devtools::install_github("stemangiola/sccomp")
```

# Analysis

In this vignette we use the `tidy` representation of single cell experiment objects using `tisyseurat` and `tidySingleCellExperiment`

## From Seurat objects

This code demonstrates how to estimate differential tissue composition from a Seurat object. `approximate_posterior_inference` is set to TRUE and `check_outliers` is set to false to speed up execution. `cores` is set up to 1 to comply with Bioconductor CHECK.

The tidy data representation nicely shows all information being used for the analysis. **Of course `sccomp_glm` works without loading `tidyseurat` **

```{r}
seurat_obj
```

```{r warning=FALSE}

seurat_obj |>
  sccomp_glm( 
  ~ type, 
  sample, cell_group,
  approximate_posterior_inference = TRUE, 
  check_outliers = FALSE,
  cores = 1
)
```

## From SingleCellExperiment objects

This code demonstrates how to estimate differential tissue composition from a SingleCellExperiment object.

The tidy data representation nicely shows all information being used for the analysis. **Of course `sccomp_glm` works without loading `tidySingleCellExperiment`.**

```{r}
sce_obj
```

```{r warning=FALSE}
sce_obj |>
 sccomp_glm( 
  ~ type, 
  sample, cell_group,
  approximate_posterior_inference = TRUE, 
  check_outliers = FALSE,
  cores = 1
)
```

## From metadata objects

This code demonstrates how to estimate differential tissue composition from a Seurat object.

```{r}
seurat_obj[[]]
```

```{r warning=FALSE}
seurat_obj[[]] |>
  sccomp_glm( 
  ~ type, 
  sample, cell_group, 
  approximate_posterior_inference = TRUE, 
  check_outliers = FALSE,
  cores = 1
)

```

## From counts (fast execution)

```{r}
counts_obj
```

```{r warning=FALSE}

counts_obj |>
sccomp_glm( 
  ~ type, 
  sample, cell_group, count, 
  approximate_posterior_inference = TRUE, 
  check_outliers = FALSE,
  cores = 1
)

```

```{r}
sessionInfo()
```

